{{ if and (eq .osid "linux-ubuntu") .personal -}}
{{ template "bash.top" . }}

# Check if 'op' command is not available
if ! command -v op &> /dev/null; then
    ARCH="amd64"
    OP_VERSION="v$(curl https://app-updates.agilebits.com/check/1/0/CLI2/en/2.0.0/N -s | grep -Eo '[0-9]+\.[0-9]+\.[0.9]+')"

    # Check if 'unzip' is not available
    if ! command -v unzip &> /dev/null; then
        echo "Error: 'unzip' command not found. Please install 'unzip' before proceeding."
        exit 1
    fi

    # Use the system's temporary directory for unzipping
    TMP_DIR="/tmp/1password_install"

    # Create the temporary directory if it doesn't exist
    mkdir -p "$TMP_DIR"

    # Download and unzip 1Password CLI in the temporary directory
    curl -sSfo "$TMP_DIR/op.zip" \
        https://cache.agilebits.com/dist/1P/op2/pkg/"$OP_VERSION"/op_linux_"$ARCH"_"$OP_VERSION".zip
    unzip -oq -d "$TMP_DIR" "$TMP_DIR/op.zip"
    rm "$TMP_DIR/op.zip"

    # Check if the unzip was successful
    if [ $? -eq 0 ]; then
        echo "1Password CLI files unzipped to $TMP_DIR."

        # Move the files to the system-wide location with sudo
        sudo mv "$TMP_DIR/op" /usr/local/bin/
        sudo mv "$TMP_DIR/op.sig" /usr/local/bin/

        # Check if the move was successful
        if [ $? -eq 0 ]; then
            echo "1Password CLI installed to /usr/local/bin."
        else
            echo "Failed to move 1Password CLI to /usr/local/bin."
            exit 1
        fi
    else
        echo "Failed to unzip 1Password CLI."
        exit 1
    fi

    # Clean up the temporary directory
    rm -rf "$TMP_DIR"
else
    echo "1Password CLI is already installed."
fi

# Check if op config file exists and create it if it doesn't. Check if the operation was successful.
if [ ! -f "$HOME/.config/op/op.key" ]; then
    # Check if op directory exists
    if [ ! -d "$HOME/.config/op" ]; then
        mkdir -p "$HOME/.config/op"
    fi

    echo "{{ joinPath .chezmoi.sourceDir "/.keys/op.key.age" | include | decrypt }}" > "$HOME/.config/op/op.key"
    if [ $? -eq 0 ]; then
        print_success "1Password CLI key file created."
        
        # Export the contents of the key file to the environment variable OP_SERVICE_ACCOUNT_TOKEN
        export OP_SERVICE_ACCOUNT_TOKEN=$(cat "$HOME/.config/op/op.key")
    else
        print_error "Failed to create 1Password CLI key file."
        exit 1
    fi
    
    # Set proper permissions for the key file
    chmod 600 "$HOME/.config/op/op.key"

else
    print_success "1Password CLI key file already exists."
fi

{{ end -}}